<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - OVS</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="brand" onclick="window.location.href='index.html'">OVS</div>
        <div class="nav-links">
            <button onclick="window.location.href='index.html'"
                style="background:transparent; border:1px solid var(--text-muted);">Back to Portals</button>
            <button onclick="window.location.href='login.html'">Already Registered? Login</button>
        </div>
    </nav>

    <div class="container animate-fade-in" style="max-width: 650px;">
        <div class="glass-panel" style="padding: 2.5rem;">
            <h2 style="margin-bottom: 2rem; text-align: center; font-family: var(--font-heading);">Create Account</h2>

            <form id="register-form">
                <div class="form-group">
                    <label>Register As</label>
                    <select id="role" onchange="toggleFields()">
                        <option value="voter">Voter</option>
                        <option value="contestant">Candidate</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="name" required placeholder="John Doe" maxlength="50">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Max 50 characters. No leading
                        spaces.</small>
                </div>

                <div class="form-group">
                    <label>Student Registration Number (Unique ID)</label>
                    <input type="text" id="regNum" required placeholder="e.g. 21B001" maxlength="10">
                    <small style="color: var(--text-muted); font-size: 0.8rem;">Max 10 characters
                        (Alphanumeric).</small>
                </div>

                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                    <div>
                        <label>Year</label>
                        <select id="year">
                            <option value="1st">1st Year</option>
                            <option value="2nd">2nd Year</option>
                            <option value="3rd">3rd Year</option>
                            <option value="4th">4th Year</option>
                        </select>
                    </div>
                    <div>
                        <label>Branch</label>
                        <select id="branch">
                            <option>CSE</option>
                            <option>ECE</option>
                            <option>EEE</option>
                            <option>CSC</option>
                            <option>MECH</option>
                            <option>IT</option>
                            <option>ECM</option>
                            <option>AIDS</option>
                            <option>CSM</option>
                            <option>CIVIL</option>
                            <option>CAI</option>
                        </select>
                    </div>
                    <div>
                        <label>Section</label>
                        <input type="text" id="section" required placeholder="1" maxlength="1">
                        <small style="color: var(--text-muted);">1 Digit (1-9) or Letter?</small>
                    </div>
                </div>

                <!-- Portrait Upload -->
                <div class="form-group">
                    <label>Add Portrait (Image or PDF)</label>
                    <input type="file" id="portrait" accept=".png, .pdf">
                    <small style="color: var(--text-muted);">Supported: PNG, PDF. Used for ID verification.</small>
                </div>

                <!-- Contestant Specific -->
                <div class="form-group hidden" id="symbol-group">
                    <label>Election Symbol (Emoji Only)</label>
                    <input type="text" id="symbol" placeholder="ðŸ¦">
                    <small style="color: var(--text-muted);">Please enter a single Emoji.</small>
                </div>

                <div class="form-group" id="password-group">
                    <label>Password</label>
                    <input type="password" id="password" required placeholder="10 Digits" maxlength="10">
                    <small style="color: var(--text-muted);">Exactly 10 Numbers.</small>
                </div>

                <button type="submit" class="submit-btn" style="margin-top: 1rem;">Complete Registration</button>
            </form>

            <div id="error-container" class="hidden"
                style="margin-top: 1rem; padding: 1rem; border-radius: 8px; background: rgba(239, 68, 68, 0.1); border: 1px solid var(--danger);">
                <p class="text-danger text-center" id="error-text"></p>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div id="msg-container" class="hidden"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index:10000; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; backdrop-filter: blur(15px); overflow-y: auto;">
        <div class="glass-panel"
            style="padding: 3rem; max-width: 90%; border-color: var(--success); box-shadow: 0 0 50px rgba(16, 185, 129, 0.2);">
            <div style="font-size: 5rem; animation: introPop 0.5s; margin-bottom: 1rem;">ðŸŽ‰</div>
            <h2 class="text-success" style="font-size: 2.5rem; margin-bottom: 1rem; font-family: var(--font-heading);">
                Registration Submitted!</h2>
            <p id="msg-text"
                style="font-size: 1.1rem; color: var(--text-muted); max-width: 400px; margin: 0 auto 2rem auto; line-height: 1.6;">
                Your registration is pending Admin Approval. You will be able to login once approved.
            </p>

            <div id="msg-actions" style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="submit-btn" style="width: auto; padding: 0.8rem 2rem; background: var(--glass-border);"
                    onclick="window.location.href='index.html'">Back to Home</button>
            </div>
        </div>
    </div>

    <script src="storage.js"></script>
    <script>
        // --- INPUT VALIDATION LOGIC ---
        const nameInput = document.getElementById('name');
        const regInput = document.getElementById('regNum');
        const passInput = document.getElementById('password');
        const sectionInput = document.getElementById('section');
        const symbolInput = document.getElementById('symbol');

        // Name: Alphabets & Spaces only. Max 50. No leading space.
        nameInput.addEventListener('input', function (e) {
            let val = this.value.replace(/[^A-Za-z ]/g, '');
            if (val.startsWith(' ')) val = val.trimStart();
            if (val.length > 50) val = val.slice(0, 50);
            this.value = val;
        });

        // RegNum: Alphanumeric only, Max 10.
        regInput.addEventListener('input', function (e) {
            this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
            if (this.value.length > 10) this.value = this.value.slice(0, 10);
        });

        // Section: 1 Digit Only, Not 0. No letters.
        // User said: "one digit number except 0 ramaining all alphabets ansd symbols are not allowed"
        // Wait, "remaining all alphabets and symbols are not allowed" -> So ONLY 1-9.
        sectionInput.addEventListener('input', function (e) {
            this.value = this.value.replace(/[^1-9]/g, ''); // Remove non 1-9
            if (this.value.length > 1) this.value = this.value.slice(0, 1);
        });

        // Password: 10 Numbers Only.
        passInput.addEventListener('input', function (e) {
            this.value = this.value.replace(/[^0-9]/g, '');
            if (this.value.length > 10) this.value = this.value.slice(0, 10);
        });

        // Symbol: Emoji Only (Basic Check)
        symbolInput.addEventListener('input', function (e) {
            // Strip all ASCII characters (0-127) effectively removing letters, numbers, and standard keyboard symbols.
            // This leaves high-bit characters like Emojis.
            // Note: This prevents entering normal text.
            this.value = this.value.replace(/[\x00-\x7F]/g, '');
        });

        function toggleFields() {
            const role = document.getElementById('role').value;
            const symbolGroup = document.getElementById('symbol-group');
            const passGroup = document.getElementById('password-group');

            if (role === 'contestant') {
                symbolGroup.classList.remove('hidden');
                document.getElementById('symbol').required = true;

                passGroup.classList.add('hidden'); // No password for candidate
                document.getElementById('password').required = false;
            } else {
                symbolGroup.classList.add('hidden');
                document.getElementById('symbol').required = false;

                passGroup.classList.remove('hidden');
                document.getElementById('password').required = true;
            }
        }

        // --- SUBMIT LOGIC ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = document.getElementById('role').value;
            const errorContainer = document.getElementById('error-container');
            const msgContainer = document.getElementById('msg-container');
            const btn = e.target.querySelector('button[type="submit"]');

            // STRICT CHECKS
            const name = nameInput.value;
            const regNum = regInput.value;
            const section = sectionInput.value;
            const password = passInput.value;
            const symbol = symbolInput.value;

            if (name.length > 50) return showError("Name too long (Max 50).");
            if (name.trim().length === 0) return showError("Name required.");
            if (!/^[A-Za-z ]+$/.test(name)) return showError("Name must contain only alphabets and spaces.");
            if (regNum.length > 10) return showError("Reg Num too long (Max 10).");
            if (!/^[1-9]$/.test(section)) return showError("Section must be a single digit (1-9).");
            if (role === 'voter' && password.length !== 10) return showError("Password must be exactly 10 numbers.");
            if (role === 'contestant') {
                // Emoji Regex Check (Basic)
                const emojiRegex = /^(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff])+$/;
                if (!emojiRegex.test(symbol)) { return showError("Symbol must be a valid Emoji (e.g. ðŸ¦)."); }
            }

            errorContainer.classList.add('hidden');
            btn.disabled = true;
            btn.innerText = "Checking file...";

            // File Handling
            const fileInput = document.getElementById('portrait');
            let portraitBase64 = null;
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];

                // PDF HANDLING
                if (file.type === 'application/pdf') {
                    if (file.size > 2 * 1024 * 1024) { // Increased to 2MB to fix "storage more" error
                        btn.disabled = false;
                        btn.innerText = "Complete Registration";
                        return showError("PDF too large. Max 2MB allowed for PDFs.");
                    }
                    try {
                        btn.innerText = "Reading PDF...";
                        portraitBase64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.readAsDataURL(file);
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = error => reject(error);
                        });
                    } catch (err) {
                        btn.disabled = false; btn.innerText = "Complete Registration";
                        return showError("PDF Read Failed");
                    }
                }
                // IMAGE HANDLING
                else {
                    // Pre-check for sanity
                    if (file.size > 10 * 1024 * 1024) { // 10MB hard limit for input image
                        btn.disabled = false; btn.innerText = "Complete Registration";
                        return showError("Image too massive (>10MB). Please use a smaller file.");
                    }

                    try {
                        btn.innerText = "Compressing Image...";
                        // Force a small UI delay to let the button text update before main thread blocks on canvas
                        await new Promise(r => setTimeout(r, 50));
                        portraitBase64 = await convertToBase64(file);
                    } catch (err) {
                        btn.disabled = false;
                        btn.innerText = "Complete Registration";
                        return showError("Image processing failed: " + err.message);
                    }
                }
            }

            btn.innerText = "Uploading...";

            const user = {
                role: role,
                name: name,
                regNum: regNum,
                year: document.getElementById('year').value,
                branch: document.getElementById('branch').value,
                section: section,
                password: (role === 'voter') ? password : null,
                symbol: (role === 'contestant') ? symbol : null,
                portrait: portraitBase64,
                hasVoted: false,
                votedFor: null,
                status: 'pending', // Pending Approval
                createdAt: new Date().toISOString()
            };

            try {
                await StorageManager.addUser(user);
                // Success
                document.getElementById('register-form').classList.add('hidden');
                msgContainer.classList.remove('hidden');
            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.innerText = "Complete Registration";
            }
        });

        function showError(msg) {
            document.getElementById('error-text').innerText = msg;
            document.getElementById('error-container').classList.remove('hidden');
        }

        function convertToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 500;
                        const MAX_HEIGHT = 500;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        // Compress to JPEG 0.7 quality
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        if (dataUrl.length > 2000000) { // Safety check ~1.5MB base64 (allows >1MB images)
                            reject(new Error("Image too complex, please use a simpler or smaller image."));
                        } else {
                            resolve(dataUrl);
                        }
                    };
                    img.onerror = (err) => reject(new Error("Image load failed"));
                };
                reader.onerror = error => reject(error);
            });
        }
    </script>
</body>

</html>